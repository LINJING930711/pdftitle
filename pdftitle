#!/usr/bin/env python

import os, sys, getopt, subprocess
from xml.etree import ElementTree

VERSION = '1.0'


def convertPDFToXML(Path):
  """Return XML string of converted PDF file."""
  Args = ['pdftohtml', '-xml', '-f', '1', '-l', '1', '-q', '-i', '-stdout', Path]
  XMLString = subprocess.check_output(Args)
  if not XMLString: raise EOFError('Conversion failed')
  return ElementTree.fromstring(XMLString)
  
def fontSpecs(XMLData):
  """Return all font specifications in XML."""
  XMLFontSpecs = XMLData.findall('page/fontspec[@id][@size]')
  return [FS.attrib for FS in XMLFontSpecs]

def sortedFontIds(FontSpecs):
  """Return sorted font specifications by size decending."""
  FontSpecs = sorted(FontSpecs, key=lambda x: int(x['size']), reverse=True)
  return [FS['id'] for FS in FontSpecs]

def textsById(XMLData, FontId):
  """Return text lines given font id."""
  TextElements = XMLData.findall('page/text[@font="%s"]' % FontId)
  return topAndTexts(TextElements)

def topAndTexts(TextElements):
  """Return top position of first non-empty text line and all
  unformatted non-empty text lines.
  Example: {'top': 16, 'text': ['a','b','c']}"""
  Top       = 0
  TextLines = []
  
  for TextElement in TextElements:
    T       = int(TextElement.get('top'))
    TextLine = unformatAndStrip(TextElement)
    if T < Top or Top == 0: Top = T
    if TextLine: TextLines.append(TextLine)
  
  if not (Top or TextLines): return {}
  return {'top': Top, 'texts': TextLines}

def unformatAndStrip(TextElement):
  """Return non-empty unformatted text element."""
  return ''.join(TextElement.itertext()).strip()

## Filters

def filterEmpties(TextBlocks):
  """Filter emtpy text blocks."""
  return filter(lambda T: T, TextBlocks)

def filterMargin(TextBlocks, TopMargin=80):
  """Filter text lines above certain top margin."""
  return filter(lambda T: T['top'] > TopMargin, TextBlocks)

def filterShorts(TextBlocks, MinLength=5):
  """Filter text lines which are too short thus unlikely titles."""
  return filter(lambda T: len(''.join(T['texts'])) >= MinLength, TextBlocks)


def title(TextBlocks, Multiline=True):
  """Return title from list. Either all non-empty texts with font id
  or just first."""
  for TextBlock in TextBlocks:
    return ' '.join(TextBlock['texts']) if Multiline else TextBlock['texts'][0]
  return None


def extractTitle(Path, Config):
  """Return title in PDF article after applying rules and filters."""
  XMLData = convertPDFToXML(Path)
  FontIds = sortedFontIds(fontSpecs(XMLData))
  Texts0  = [textsById(XMLData, FontId) for FontId in FontIds]
  Texts1  = filterEmpties(Texts0)
  Texts2  = filterMargin(Texts1, Config['topMargin'])
  Texts3  = filterShorts(Texts2, Config['minLength'])
  Title   = title(Texts3, Config['multiline'])
  return Title


def usage():
  print 'Usage: %s [options...] <file>' % os.path.basename(sys.argv[0])
  print
  print 'Options:'
  print ' -h, --help       Show usage screen'
  print ' -v, --version    Show version info'
  print ' -m, --multi      Concatenate multiple title lines found (default)'
  print ' -s, --single     Only use first title line found'
  print ' -t, --top=<n>    Points from top to skip when searching for title (default: 80)'
  print ' -l, --length=<n> Min title length to accept (default: 5)'


def main(Argv=None):
  """Find first non-empty text in PDF File with largest size and return as
  unformatted string."""
  if Argv is None:
      Argv = sys.argv[1:]

  ## Argument parsing
  try:
    LongOpts = ['help', 'version', 'multi', 'single', 'top=', 'length=']
    Opts, Args = getopt.getopt(Argv, 'hvmst:l:', LongOpts)
  except getopt.GetoptError as err:
    print str(err)
    usage()
    return 1

  Multiline = True
  TopMargin = 80
  MinLength = 5
  
  try:
    for o, a in Opts:
      if (o in ['-h', '--help']):
        usage()
        return 0
      elif (o in ['-v', '--version']):
        print VERSION
        return 0
      elif (o in ['-m', '--multi']):
        Multiline = True
      elif (o in ['-s', '--single']):
        Multiline = False
      elif (o in ['-t', '--top']):
        TopMargin = int(a)
        if TopMargin < 0: raise ValueError
      elif (o in ['-l', '--length']):
        MinLength = int(a)
        if MinLength < 0: raise ValueError
      else:
        print 'Invalid argument'
        usage()
        return 2
    
    Config = {
      'multiline': Multiline,
      'topMargin': TopMargin,
      'minLength': MinLength
    }

    if len(Args) >= 1:
      Path = Args[0]
    else:
      usage()
      return 2

    if not os.path.isfile(Path): raise IOError
    Title = extractTitle(Path, Config)

    if Title:
      print Title
    else:
      print 'No title found'
      return 1
  except ValueError:
    print 'Invalid argument value'
    usage()
    return 2
  except IOError:
    print 'No such file'
    return 3
  except OSError:
    print 'pdftohtml not found'
    return 4
  except EOFError:
    print 'Could not convert PDF to XML'
    return 5
  except ElementTree.ParseError:
    print 'Could not parse XML'
    return 6
  except:
    print 'Unknown error'
    return 8

if __name__ == '__main__':
  sys.exit(main())
